# GitHub Actions workflow for compiling Arduino firmware
# ç”¨äºŽç¼–è¯‘ Arduino å›ºä»¶çš„ GitHub Actions å·¥ä½œæµ
#
# This workflow automatically compiles ONLY the firmware that was modified.
# æ­¤å·¥ä½œæµè‡ªåŠ¨åªç¼–è¯‘è¢«ä¿®æ”¹çš„å›ºä»¶ã€‚
#
# Smart build detection:
# æ™ºèƒ½æž„å»ºæ£€æµ‹ï¼š
# - If library source (src/) changes: rebuild ALL firmware
#   å¦‚æžœåº“æºç ï¼ˆsrc/ï¼‰æ›´æ”¹ï¼šé‡æ–°æž„å»ºæ‰€æœ‰å›ºä»¶
# - If specific example changes: rebuild ONLY that firmware
#   å¦‚æžœç‰¹å®šç¤ºä¾‹æ›´æ”¹ï¼šåªé‡æ–°æž„å»ºè¯¥å›ºä»¶
# - Manual trigger: can choose to build all or specific firmware
#   æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥é€‰æ‹©æž„å»ºæ‰€æœ‰æˆ–ç‰¹å®šå›ºä»¶

name: Build Firmware

on:
  push:
    branches: [main, master]
    paths:
      - 'arduino/**'
      - '.github/workflows/build-firmware.yml'
  pull_request:
    paths:
      - 'arduino/**'
  workflow_dispatch:  # Allow manual trigger | å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      build_all:
        description: 'Build all firmware (ignore change detection)'
        required: false
        default: 'false'
        type: boolean
      firmware:
        description: 'Specific firmware to build (leave empty for auto-detect)'
        required: false
        default: ''
        type: string

env:
  ARDUINO_CLI_VERSION: "0.35.3"
  ESP32_CORE_VERSION: "3.3.4"  # Lock ESP32 Core version for build consistency | é”å®š ESP32 Core ç‰ˆæœ¬ä»¥ç¡®ä¿æž„å»ºä¸€è‡´æ€§

jobs:
  # Detect which firmware needs to be built | æ£€æµ‹éœ€è¦æž„å»ºçš„å›ºä»¶
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      build_iot_button: ${{ steps.check.outputs.build_iot_button }}
      build_wifi_provisioning: ${{ steps.check.outputs.build_wifi_provisioning }}
      library_changed: ${{ steps.check.outputs.library_changed }}
      any_firmware_changed: ${{ steps.check.outputs.any_firmware_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes | éœ€è¦ä¸Šä¸€ä¸ªæäº¤æ¥æ£€æµ‹æ›´æ”¹

      - name: Detect changed files
        id: check
        run: |
          echo "Detecting changed files..."
          
          # For manual trigger with build_all, build everything
          # æ‰‹åŠ¨è§¦å‘ä¸” build_all ä¸º true æ—¶ï¼Œæž„å»ºæ‰€æœ‰
          if [ "${{ github.event.inputs.build_all }}" == "true" ]; then
            echo "Manual trigger: building all firmware"
            echo "build_iot_button=true" >> $GITHUB_OUTPUT
            echo "build_wifi_provisioning=true" >> $GITHUB_OUTPUT
            echo "library_changed=true" >> $GITHUB_OUTPUT
            echo "any_firmware_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For manual trigger with specific firmware
          # æ‰‹åŠ¨è§¦å‘æŒ‡å®šç‰¹å®šå›ºä»¶
          if [ -n "${{ github.event.inputs.firmware }}" ]; then
            echo "Manual trigger: building specific firmware: ${{ github.event.inputs.firmware }}"
            if [ "${{ github.event.inputs.firmware }}" == "IoTButtonV2_DeepSleep" ]; then
              echo "build_iot_button=true" >> $GITHUB_OUTPUT
              echo "build_wifi_provisioning=false" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.inputs.firmware }}" == "WiFiProvisioning" ]; then
              echo "build_iot_button=false" >> $GITHUB_OUTPUT
              echo "build_wifi_provisioning=true" >> $GITHUB_OUTPUT
            fi
            echo "library_changed=false" >> $GITHUB_OUTPUT
            echo "any_firmware_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get changed files | èŽ·å–æ›´æ”¹çš„æ–‡ä»¶
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Initialize flags | åˆå§‹åŒ–æ ‡å¿—
          BUILD_IOT_BUTTON=false
          BUILD_WIFI_PROVISIONING=false
          LIBRARY_CHANGED=false
          
          # Check if library source changed | æ£€æŸ¥åº“æºç æ˜¯å¦æ›´æ”¹
          if echo "$CHANGED_FILES" | grep -q "arduino/SeeedHADiscovery/src/"; then
            echo "Library source changed - will rebuild ALL firmware"
            LIBRARY_CHANGED=true
            BUILD_IOT_BUTTON=true
            BUILD_WIFI_PROVISIONING=true
          fi
          
          # Check if workflow file changed | æ£€æŸ¥å·¥ä½œæµæ–‡ä»¶æ˜¯å¦æ›´æ”¹
          if echo "$CHANGED_FILES" | grep -q ".github/workflows/build-firmware.yml"; then
            echo "Workflow file changed - will rebuild ALL firmware"
            BUILD_IOT_BUTTON=true
            BUILD_WIFI_PROVISIONING=true
          fi
          
          # Check specific firmware changes | æ£€æŸ¥ç‰¹å®šå›ºä»¶æ›´æ”¹
          if echo "$CHANGED_FILES" | grep -q "arduino/SeeedHADiscovery/examples/IoTButtonV2_DeepSleep/"; then
            echo "IoTButtonV2_DeepSleep changed"
            BUILD_IOT_BUTTON=true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "arduino/SeeedHADiscovery/examples/WiFiProvisioning/"; then
            echo "WiFiProvisioning changed"
            BUILD_WIFI_PROVISIONING=true
          fi
          
          # Check if any firmware needs building | æ£€æŸ¥æ˜¯å¦æœ‰å›ºä»¶éœ€è¦æž„å»º
          ANY_CHANGED=false
          if [ "$BUILD_IOT_BUTTON" == "true" ] || [ "$BUILD_WIFI_PROVISIONING" == "true" ]; then
            ANY_CHANGED=true
          fi
          
          # Output results | è¾“å‡ºç»“æžœ
          echo ""
          echo "Build decisions:"
          echo "  - IoTButtonV2_DeepSleep: $BUILD_IOT_BUTTON"
          echo "  - WiFiProvisioning: $BUILD_WIFI_PROVISIONING"
          echo "  - Library changed: $LIBRARY_CHANGED"
          echo "  - Any firmware to build: $ANY_CHANGED"
          
          echo "build_iot_button=$BUILD_IOT_BUTTON" >> $GITHUB_OUTPUT
          echo "build_wifi_provisioning=$BUILD_WIFI_PROVISIONING" >> $GITHUB_OUTPUT
          echo "library_changed=$LIBRARY_CHANGED" >> $GITHUB_OUTPUT
          echo "any_firmware_changed=$ANY_CHANGED" >> $GITHUB_OUTPUT

  # Build IoTButtonV2_DeepSleep firmware | æž„å»º IoTButtonV2_DeepSleep å›ºä»¶
  build-iot-button:
    needs: detect-changes
    if: needs.detect-changes.outputs.build_iot_button == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=/usr/local/bin sh
          arduino-cli version

      - name: Install platform and libraries
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls "https://espressif.github.io/arduino-esp32/package_esp32_index.json"
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}
          
          arduino-cli lib install "ArduinoJson"
          arduino-cli lib install "WebSockets"
          arduino-cli lib install "Adafruit NeoPixel"
          
          mkdir -p ~/Arduino/libraries
          cp -r arduino/SeeedHADiscovery ~/Arduino/libraries/

      - name: Compile IoTButtonV2_DeepSleep
        run: |
          mkdir -p build/IoTButtonV2_DeepSleep
          arduino-cli compile \
            --fqbn "esp32:esp32:esp32c6:CDCOnBoot=cdc,PartitionScheme=huge_app,CPUFreq=80,FlashMode=qio,FlashSize=4M,UploadSpeed=921600" \
            --output-dir "build/IoTButtonV2_DeepSleep" \
            --export-binaries \
            "arduino/SeeedHADiscovery/examples/IoTButtonV2_DeepSleep/IoTButtonV2_DeepSleep.ino"
          
          echo "Compiled files:"
          ls -la build/IoTButtonV2_DeepSleep/

      - name: Prepare firmware files
        run: |
          cd build/IoTButtonV2_DeepSleep
          
          for f in *.bin; do
            if [[ "$f" == *".ino.bin" ]]; then
              mv "$f" "firmware.bin"
            elif [[ "$f" == *".bootloader.bin" ]]; then
              mv "$f" "bootloader.bin"
            elif [[ "$f" == *".partitions.bin" ]]; then
              mv "$f" "partitions.bin"
            fi
          done
          
          # Copy boot_app0.bin
          ESP32_CORE_PATH=$(find ~/.arduino15/packages/esp32/hardware/esp32 -maxdepth 1 -type d -name "${{ env.ESP32_CORE_VERSION }}" | head -1)
          if [ -n "$ESP32_CORE_PATH" ] && [ -f "$ESP32_CORE_PATH/tools/partitions/boot_app0.bin" ]; then
            cp "$ESP32_CORE_PATH/tools/partitions/boot_app0.bin" ./boot_app0.bin
          else
            BOOT_APP0=$(find ~/.arduino15/packages/esp32 -name "boot_app0.bin" -type f | head -1)
            cp "$BOOT_APP0" ./boot_app0.bin
          fi
          
          # Create manifest.json
          cat > manifest.json << 'EOF'
          {
            "name": "IoTButtonV2_DeepSleep",
            "version": "1.0.0",
            "home_assistant_domain": "seeed_ha_discovery",
            "funding_url": "https://www.seeedstudio.com/",
            "new_install_prompt_erase": true,
            "new_install_improv_wait_time": 0,
            "builds": [
              {
                "chipFamily": "ESP32-C6",
                "parts": [
                  { "path": "bootloader.bin", "offset": 0 },
                  { "path": "partitions.bin", "offset": 32768 },
                  { "path": "boot_app0.bin", "offset": 57344 },
                  { "path": "firmware.bin", "offset": 65536 }
                ]
              }
            ]
          }
          EOF
          
          echo "Final files:"
          ls -la

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-IoTButtonV2_DeepSleep
          path: build/IoTButtonV2_DeepSleep/
          retention-days: 30

  # Build WiFiProvisioning firmware | æž„å»º WiFiProvisioning å›ºä»¶
  build-wifi-provisioning:
    needs: detect-changes
    if: needs.detect-changes.outputs.build_wifi_provisioning == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=/usr/local/bin sh
          arduino-cli version

      - name: Install platform and libraries
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls "https://espressif.github.io/arduino-esp32/package_esp32_index.json"
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}
          
          arduino-cli lib install "ArduinoJson"
          arduino-cli lib install "WebSockets"
          arduino-cli lib install "Adafruit NeoPixel"
          
          mkdir -p ~/Arduino/libraries
          cp -r arduino/SeeedHADiscovery ~/Arduino/libraries/

      - name: Compile WiFiProvisioning
        run: |
          mkdir -p build/WiFiProvisioning
          arduino-cli compile \
            --fqbn "esp32:esp32:esp32c6:CDCOnBoot=cdc,PartitionScheme=huge_app,CPUFreq=80,FlashMode=qio,FlashSize=4M,UploadSpeed=921600" \
            --output-dir "build/WiFiProvisioning" \
            --export-binaries \
            "arduino/SeeedHADiscovery/examples/WiFiProvisioning/WiFiProvisioning.ino"
          
          echo "Compiled files:"
          ls -la build/WiFiProvisioning/

      - name: Prepare firmware files
        run: |
          cd build/WiFiProvisioning
          
          for f in *.bin; do
            if [[ "$f" == *".ino.bin" ]]; then
              mv "$f" "firmware.bin"
            elif [[ "$f" == *".bootloader.bin" ]]; then
              mv "$f" "bootloader.bin"
            elif [[ "$f" == *".partitions.bin" ]]; then
              mv "$f" "partitions.bin"
            fi
          done
          
          # Copy boot_app0.bin
          ESP32_CORE_PATH=$(find ~/.arduino15/packages/esp32/hardware/esp32 -maxdepth 1 -type d -name "${{ env.ESP32_CORE_VERSION }}" | head -1)
          if [ -n "$ESP32_CORE_PATH" ] && [ -f "$ESP32_CORE_PATH/tools/partitions/boot_app0.bin" ]; then
            cp "$ESP32_CORE_PATH/tools/partitions/boot_app0.bin" ./boot_app0.bin
          else
            BOOT_APP0=$(find ~/.arduino15/packages/esp32 -name "boot_app0.bin" -type f | head -1)
            cp "$BOOT_APP0" ./boot_app0.bin
          fi
          
          # Create manifest.json
          cat > manifest.json << 'EOF'
          {
            "name": "WiFiProvisioning",
            "version": "1.0.0",
            "home_assistant_domain": "seeed_ha_discovery",
            "funding_url": "https://www.seeedstudio.com/",
            "new_install_prompt_erase": true,
            "new_install_improv_wait_time": 0,
            "builds": [
              {
                "chipFamily": "ESP32-C6",
                "parts": [
                  { "path": "bootloader.bin", "offset": 0 },
                  { "path": "partitions.bin", "offset": 32768 },
                  { "path": "boot_app0.bin", "offset": 57344 },
                  { "path": "firmware.bin", "offset": 65536 }
                ]
              }
            ]
          }
          EOF
          
          echo "Final files:"
          ls -la

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-WiFiProvisioning
          path: build/WiFiProvisioning/
          retention-days: 30

  # Combine all built firmware | åˆå¹¶æ‰€æœ‰æž„å»ºçš„å›ºä»¶
  combine:
    needs: [detect-changes, build-iot-button, build-wifi-provisioning]
    if: always() && needs.detect-changes.outputs.any_firmware_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-firmware/
          pattern: firmware-*
        continue-on-error: true  # Some artifacts may not exist | æŸäº› artifact å¯èƒ½ä¸å­˜åœ¨

      - name: Check downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la all-firmware/ 2>/dev/null || echo "No artifacts directory"
          find all-firmware -type f 2>/dev/null || echo "No files found"

      - name: Reorganize firmware files
        run: |
          mkdir -p combined-firmware
          
          if [ -d "all-firmware" ]; then
            for dir in all-firmware/firmware-*; do
              if [ -d "$dir" ]; then
                firmware_name=$(basename "$dir" | sed 's/firmware-//')
                echo "Adding firmware: $firmware_name"
                cp -r "$dir" "combined-firmware/$firmware_name"
              fi
            done
          fi
          
          echo "Combined firmware structure:"
          find combined-firmware -type f 2>/dev/null || echo "No firmware files"

      - name: Upload combined firmware
        uses: actions/upload-artifact@v4
        with:
          name: all-firmware
          path: combined-firmware/
          retention-days: 90
        if: hashFiles('combined-firmware/**') != ''

  # Create release | åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  release:
    needs: [detect-changes, combine]
    if: always() && needs.detect-changes.outputs.any_firmware_changed == 'true' && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog | å®Œæ•´åŽ†å²ç”¨äºŽæ›´æ–°æ—¥å¿—

      - name: Download combined firmware
        uses: actions/download-artifact@v4
        with:
          name: all-firmware
          path: firmware/
        continue-on-error: true

      - name: Check firmware exists
        id: check_firmware
        run: |
          if [ -d "firmware" ] && [ "$(ls -A firmware 2>/dev/null)" ]; then
            echo "has_firmware=true" >> $GITHUB_OUTPUT
            echo "Firmware directory contents:"
            find firmware -type f
          else
            echo "has_firmware=false" >> $GITHUB_OUTPUT
            echo "No firmware to release"
          fi

      - name: Get version and changelog
        id: version
        if: steps.check_firmware.outputs.has_firmware == 'true'
        run: |
          VERSION=$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Get the last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          echo "Generating changelog..."
          if [ -n "$LAST_TAG" ]; then
            echo "Changes since $LAST_TAG:"
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | head -30)
          else
            echo "No previous tag found, using last 20 commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          
          echo "$CHANGELOG" > changelog.txt
          cat changelog.txt

      - name: Package firmware
        if: steps.check_firmware.outputs.has_firmware == 'true'
        run: |
          cd firmware
          
          for dir in */; do
            firmware_name="${dir%/}"
            echo "Packaging $firmware_name..."
            zip -r "${firmware_name}.zip" "$dir"
          done
          
          cd ..
          zip -r "all-firmware.zip" firmware/
          mv all-firmware.zip firmware/
          
          echo "Created packages:"
          ls -la firmware/*.zip

      - name: Generate release body
        if: steps.check_firmware.outputs.has_firmware == 'true'
        run: |
          CHANGELOG=$(cat changelog.txt)
          
          # List which firmware was built | åˆ—å‡ºæž„å»ºäº†å“ªäº›å›ºä»¶
          BUILT_FIRMWARE=""
          for dir in firmware/*/; do
            firmware_name=$(basename "$dir")
            if [ "$firmware_name" != "*.zip" ]; then
              BUILT_FIRMWARE="$BUILT_FIRMWARE\n- $firmware_name"
            fi
          done
          
          cat > release_body.md << ENDOFHEADER
          ## ðŸš€ Firmware Release
          
          Pre-compiled firmware for Seeed HA Discovery devices.
          ä¸º Seeed HA Discovery è®¾å¤‡é¢„ç¼–è¯‘çš„å›ºä»¶ã€‚
          
          ### ðŸ“¥ How to Flash | å¦‚ä½•çƒ§å½•
          
          **Web Flasher (Recommended | æŽ¨è):**
          Visit [Web Flasher](https://limengdu.github.io/Seeed-Homeassistant-Discovery/flasher/) to flash directly from browser.
          è®¿é—® [ç½‘é¡µçƒ§å½•å™¨](https://limengdu.github.io/Seeed-Homeassistant-Discovery/flasher/) ç›´æŽ¥ä»Žæµè§ˆå™¨çƒ§å½•ã€‚
          
          ### ðŸ“¦ Firmware in this release | æœ¬æ¬¡å‘å¸ƒçš„å›ºä»¶
          $(echo -e "$BUILT_FIRMWARE")
          
          ### ðŸ“ Changelog | æ›´æ–°æ—¥å¿—
          
          $CHANGELOG
          
          ---
          
          **Build Info | æž„å»ºä¿¡æ¯:**
          - ESP32 Core Version: ${{ env.ESP32_CORE_VERSION }}
          - Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Commit: ${{ github.sha }}
          ENDOFHEADER
          
          cat release_body.md

      - name: Create Release
        if: steps.check_firmware.outputs.has_firmware == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware-${{ steps.version.outputs.version }}
          name: Firmware Release ${{ steps.version.outputs.version }}
          body_path: release_body.md
          files: |
            firmware/*.zip
