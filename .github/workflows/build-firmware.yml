# GitHub Actions workflow for compiling Arduino firmware
# ç”¨äºç¼–è¯‘ Arduino å›ºä»¶çš„ GitHub Actions å·¥ä½œæµ
#
# This workflow automatically compiles ONLY the firmware that was modified.
# æ­¤å·¥ä½œæµè‡ªåŠ¨åªç¼–è¯‘è¢«ä¿®æ”¹çš„å›ºä»¶ã€‚
#
# Smart build detection:
# æ™ºèƒ½æ„å»ºæ£€æµ‹ï¼š
# - If library source (src/) changes: rebuild ALL firmware
#   å¦‚æœåº“æºç ï¼ˆsrc/ï¼‰æ›´æ”¹ï¼šé‡æ–°æ„å»ºæ‰€æœ‰å›ºä»¶
# - If specific example changes: rebuild ONLY that firmware
#   å¦‚æœç‰¹å®šç¤ºä¾‹æ›´æ”¹ï¼šåªé‡æ–°æ„å»ºè¯¥å›ºä»¶
# - Manual trigger: can choose to build all or specific firmware
#   æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥é€‰æ‹©æ„å»ºæ‰€æœ‰æˆ–ç‰¹å®šå›ºä»¶

name: Build Firmware

on:
  push:
    branches: [main, master]
    paths:
      - 'arduino/**'
      - '.github/workflows/build-firmware.yml'
  pull_request:
    paths:
      - 'arduino/**'
  workflow_dispatch:  # Allow manual trigger | å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      build_all:
        description: 'Build all firmware (ignore change detection)'
        required: false
        default: 'false'
        type: boolean
      firmware:
        description: 'Specific firmware to build (leave empty for auto-detect)'
        required: false
        default: ''
        type: string

env:
  ARDUINO_CLI_VERSION: "0.35.3"
  ESP32_CORE_VERSION: "3.3.4"  # Lock ESP32 Core version for build consistency | é”å®š ESP32 Core ç‰ˆæœ¬ä»¥ç¡®ä¿æ„å»ºä¸€è‡´æ€§
  # Library versions (locked for build stability) | åº“ç‰ˆæœ¬ï¼ˆé”å®šä»¥ç¡®ä¿æ„å»ºç¨³å®šæ€§ï¼‰
  ARDUINOJSON_VERSION: "7.4.2"
  WEBSOCKETS_VERSION: "2.7.1"
  NEOPIXEL_VERSION: "1.15.2"

jobs:
  # Detect which firmware needs to be built | æ£€æµ‹éœ€è¦æ„å»ºçš„å›ºä»¶
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      build_iot_button: ${{ steps.check.outputs.build_iot_button }}
      build_wifi_provisioning: ${{ steps.check.outputs.build_wifi_provisioning }}
      library_changed: ${{ steps.check.outputs.library_changed }}
      any_firmware_changed: ${{ steps.check.outputs.any_firmware_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes | éœ€è¦ä¸Šä¸€ä¸ªæäº¤æ¥æ£€æµ‹æ›´æ”¹

      - name: Detect changed files
        id: check
        run: |
          echo "Detecting changed files..."
          
          # For manual trigger with build_all, build everything
          # æ‰‹åŠ¨è§¦å‘ä¸” build_all ä¸º true æ—¶ï¼Œæ„å»ºæ‰€æœ‰
          if [ "${{ github.event.inputs.build_all }}" == "true" ]; then
            echo "Manual trigger: building all firmware"
            echo "build_iot_button=true" >> $GITHUB_OUTPUT
            echo "build_wifi_provisioning=true" >> $GITHUB_OUTPUT
            echo "library_changed=true" >> $GITHUB_OUTPUT
            echo "any_firmware_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For manual trigger with specific firmware
          # æ‰‹åŠ¨è§¦å‘æŒ‡å®šç‰¹å®šå›ºä»¶
          if [ -n "${{ github.event.inputs.firmware }}" ]; then
            echo "Manual trigger: building specific firmware: ${{ github.event.inputs.firmware }}"
            if [ "${{ github.event.inputs.firmware }}" == "IoTButtonV2_DeepSleep" ]; then
              echo "build_iot_button=true" >> $GITHUB_OUTPUT
              echo "build_wifi_provisioning=false" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.inputs.firmware }}" == "WiFiProvisioning" ]; then
              echo "build_iot_button=false" >> $GITHUB_OUTPUT
              echo "build_wifi_provisioning=true" >> $GITHUB_OUTPUT
            fi
            echo "library_changed=false" >> $GITHUB_OUTPUT
            echo "any_firmware_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get changed files | è·å–æ›´æ”¹çš„æ–‡ä»¶
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Initialize flags | åˆå§‹åŒ–æ ‡å¿—
          BUILD_IOT_BUTTON=false
          BUILD_WIFI_PROVISIONING=false
          LIBRARY_CHANGED=false
          
          # Check if library source changed | æ£€æŸ¥åº“æºç æ˜¯å¦æ›´æ”¹
          if echo "$CHANGED_FILES" | grep -q "arduino/SeeedHADiscovery/src/"; then
            echo "Library source changed - will rebuild ALL firmware"
            LIBRARY_CHANGED=true
            BUILD_IOT_BUTTON=true
            BUILD_WIFI_PROVISIONING=true
          fi
          
          # Check if workflow file changed | æ£€æŸ¥å·¥ä½œæµæ–‡ä»¶æ˜¯å¦æ›´æ”¹
          if echo "$CHANGED_FILES" | grep -q ".github/workflows/build-firmware.yml"; then
            echo "Workflow file changed - will rebuild ALL firmware"
            BUILD_IOT_BUTTON=true
            BUILD_WIFI_PROVISIONING=true
          fi
          
          # Check specific firmware changes | æ£€æŸ¥ç‰¹å®šå›ºä»¶æ›´æ”¹
          if echo "$CHANGED_FILES" | grep -q "arduino/SeeedHADiscovery/examples/IoTButtonV2_DeepSleep/"; then
            echo "IoTButtonV2_DeepSleep changed"
            BUILD_IOT_BUTTON=true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "arduino/SeeedHADiscovery/examples/WiFiProvisioning/"; then
            echo "WiFiProvisioning changed"
            BUILD_WIFI_PROVISIONING=true
          fi
          
          # Check if any firmware needs building | æ£€æŸ¥æ˜¯å¦æœ‰å›ºä»¶éœ€è¦æ„å»º
          ANY_CHANGED=false
          if [ "$BUILD_IOT_BUTTON" == "true" ] || [ "$BUILD_WIFI_PROVISIONING" == "true" ]; then
            ANY_CHANGED=true
          fi
          
          # Output results | è¾“å‡ºç»“æœ
          echo ""
          echo "Build decisions:"
          echo "  - IoTButtonV2_DeepSleep: $BUILD_IOT_BUTTON"
          echo "  - WiFiProvisioning: $BUILD_WIFI_PROVISIONING"
          echo "  - Library changed: $LIBRARY_CHANGED"
          echo "  - Any firmware to build: $ANY_CHANGED"
          
          echo "build_iot_button=$BUILD_IOT_BUTTON" >> $GITHUB_OUTPUT
          echo "build_wifi_provisioning=$BUILD_WIFI_PROVISIONING" >> $GITHUB_OUTPUT
          echo "library_changed=$LIBRARY_CHANGED" >> $GITHUB_OUTPUT
          echo "any_firmware_changed=$ANY_CHANGED" >> $GITHUB_OUTPUT

  # Build IoTButtonV2_DeepSleep firmware | æ„å»º IoTButtonV2_DeepSleep å›ºä»¶
  build-iot-button:
    needs: detect-changes
    if: needs.detect-changes.outputs.build_iot_button == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=/usr/local/bin sh
          arduino-cli version

      - name: Install platform and libraries
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls "https://espressif.github.io/arduino-esp32/package_esp32_index.json"
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}
          
          # Install libraries with locked versions | å®‰è£…é”å®šç‰ˆæœ¬çš„åº“
          arduino-cli lib install "ArduinoJson@${{ env.ARDUINOJSON_VERSION }}"
          arduino-cli lib install "WebSockets@${{ env.WEBSOCKETS_VERSION }}"
          arduino-cli lib install "Adafruit NeoPixel@${{ env.NEOPIXEL_VERSION }}"
          
          echo "Installed library versions:"
          arduino-cli lib list
          
          mkdir -p ~/Arduino/libraries
          cp -r arduino/SeeedHADiscovery ~/Arduino/libraries/

      - name: Compile IoTButtonV2_DeepSleep
        run: |
          mkdir -p build/IoTButtonV2_DeepSleep
          arduino-cli compile \
            --fqbn "esp32:esp32:esp32c6:CDCOnBoot=cdc,PartitionScheme=huge_app,CPUFreq=80,FlashMode=qio,FlashSize=4M,UploadSpeed=921600" \
            --output-dir "build/IoTButtonV2_DeepSleep" \
            --export-binaries \
            "arduino/SeeedHADiscovery/examples/IoTButtonV2_DeepSleep/IoTButtonV2_DeepSleep.ino"
          
          echo "Compiled files:"
          ls -la build/IoTButtonV2_DeepSleep/

      - name: Prepare firmware files
        run: |
          cd build/IoTButtonV2_DeepSleep
          
          for f in *.bin; do
            if [[ "$f" == *".ino.bin" ]]; then
              mv "$f" "firmware.bin"
            elif [[ "$f" == *".bootloader.bin" ]]; then
              mv "$f" "bootloader.bin"
            elif [[ "$f" == *".partitions.bin" ]]; then
              mv "$f" "partitions.bin"
            fi
          done
          
          # Copy boot_app0.bin
          ESP32_CORE_PATH=$(find ~/.arduino15/packages/esp32/hardware/esp32 -maxdepth 1 -type d -name "${{ env.ESP32_CORE_VERSION }}" | head -1)
          if [ -n "$ESP32_CORE_PATH" ] && [ -f "$ESP32_CORE_PATH/tools/partitions/boot_app0.bin" ]; then
            cp "$ESP32_CORE_PATH/tools/partitions/boot_app0.bin" ./boot_app0.bin
          else
            BOOT_APP0=$(find ~/.arduino15/packages/esp32 -name "boot_app0.bin" -type f | head -1)
            cp "$BOOT_APP0" ./boot_app0.bin
          fi
          
          # Create manifest.json
          cat > manifest.json << 'EOF'
          {
            "name": "IoTButtonV2_DeepSleep",
            "version": "1.0.0",
            "home_assistant_domain": "seeed_ha_discovery",
            "funding_url": "https://www.seeedstudio.com/",
            "new_install_prompt_erase": true,
            "new_install_improv_wait_time": 0,
            "builds": [
              {
                "chipFamily": "ESP32-C6",
                "parts": [
                  { "path": "bootloader.bin", "offset": 0 },
                  { "path": "partitions.bin", "offset": 32768 },
                  { "path": "boot_app0.bin", "offset": 57344 },
                  { "path": "firmware.bin", "offset": 65536 }
                ]
              }
            ]
          }
          EOF
          
          echo "Final files:"
          ls -la

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-IoTButtonV2_DeepSleep
          path: build/IoTButtonV2_DeepSleep/
          retention-days: 30

  # Build WiFiProvisioning firmware for multiple ESP32 chips | ä¸ºå¤šç§ ESP32 èŠ¯ç‰‡æ„å»º WiFiProvisioning å›ºä»¶
  # This is a generic example that works on all ESP32 variants | è¿™æ˜¯ä¸€ä¸ªé€‚ç”¨äºæ‰€æœ‰ ESP32 ç³»åˆ—çš„é€šç”¨ç¤ºä¾‹
  build-wifi-provisioning:
    needs: detect-changes
    if: needs.detect-changes.outputs.build_wifi_provisioning == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # ESP32-C3 (XIAO ESP32C3) | ESP32-C3ï¼ˆXIAO ESP32C3ï¼‰
          - chip: "C3"
            fqbn: "esp32:esp32:esp32c3:CDCOnBoot=cdc,PartitionScheme=huge_app,CPUFreq=80,FlashMode=qio,FlashSize=4M,UploadSpeed=921600"
            chip_family: "ESP32-C3"
            bootloader_offset: 0
          # ESP32-C6 (XIAO ESP32C6) | ESP32-C6ï¼ˆXIAO ESP32C6ï¼‰
          - chip: "C6"
            fqbn: "esp32:esp32:esp32c6:CDCOnBoot=cdc,PartitionScheme=huge_app,CPUFreq=80,FlashMode=qio,FlashSize=4M,UploadSpeed=921600"
            chip_family: "ESP32-C6"
            bootloader_offset: 0
          # ESP32-S3 (XIAO ESP32S3) | ESP32-S3ï¼ˆXIAO ESP32S3ï¼‰
          - chip: "S3"
            fqbn: "esp32:esp32:esp32s3:CDCOnBoot=cdc,PartitionScheme=huge_app,USBMode=hwcdc,FlashMode=qio,FlashSize=8M,UploadSpeed=921600,PSRAM=opi"
            chip_family: "ESP32-S3"
            bootloader_offset: 0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=/usr/local/bin sh
          arduino-cli version

      - name: Install platform and libraries
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls "https://espressif.github.io/arduino-esp32/package_esp32_index.json"
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}
          
          # Install libraries with locked versions | å®‰è£…é”å®šç‰ˆæœ¬çš„åº“
          arduino-cli lib install "ArduinoJson@${{ env.ARDUINOJSON_VERSION }}"
          arduino-cli lib install "WebSockets@${{ env.WEBSOCKETS_VERSION }}"
          arduino-cli lib install "Adafruit NeoPixel@${{ env.NEOPIXEL_VERSION }}"
          
          echo "Installed library versions:"
          arduino-cli lib list
          
          mkdir -p ~/Arduino/libraries
          cp -r arduino/SeeedHADiscovery ~/Arduino/libraries/

      - name: Compile WiFiProvisioning for ${{ matrix.chip }}
        run: |
          FIRMWARE_NAME="WiFiProvisioning-${{ matrix.chip }}"
          mkdir -p build/${FIRMWARE_NAME}
          
          echo "Compiling for ${{ matrix.chip_family }}..."
          arduino-cli compile \
            --fqbn "${{ matrix.fqbn }}" \
            --output-dir "build/${FIRMWARE_NAME}" \
            --export-binaries \
            "arduino/SeeedHADiscovery/examples/WiFiProvisioning/WiFiProvisioning.ino"
          
          echo "Compiled files:"
          ls -la build/${FIRMWARE_NAME}/

      - name: Prepare firmware files for ${{ matrix.chip }}
        run: |
          # Create chip-specific subfolder | åˆ›å»ºèŠ¯ç‰‡ç‰¹å®šçš„å­æ–‡ä»¶å¤¹
          # Structure: WiFiProvisioning/C3/, WiFiProvisioning/C6/, WiFiProvisioning/S3/
          # ESP Web Tools will auto-detect chip and use correct subfolder
          # ESP Web Tools ä¼šè‡ªåŠ¨æ£€æµ‹èŠ¯ç‰‡å¹¶ä½¿ç”¨æ­£ç¡®çš„å­æ–‡ä»¶å¤¹
          
          CHIP_DIR="build/WiFiProvisioning/${{ matrix.chip }}"
          mkdir -p ${CHIP_DIR}
          
          # Move and rename binaries to chip subfolder | ç§»åŠ¨å¹¶é‡å‘½åäºŒè¿›åˆ¶æ–‡ä»¶åˆ°èŠ¯ç‰‡å­æ–‡ä»¶å¤¹
          cd build/WiFiProvisioning-${{ matrix.chip }}
          for f in *.bin; do
            if [[ "$f" == *".ino.bin" ]]; then
              cp "$f" "../WiFiProvisioning/${{ matrix.chip }}/firmware.bin"
            elif [[ "$f" == *".bootloader.bin" ]]; then
              cp "$f" "../WiFiProvisioning/${{ matrix.chip }}/bootloader.bin"
            elif [[ "$f" == *".partitions.bin" ]]; then
              cp "$f" "../WiFiProvisioning/${{ matrix.chip }}/partitions.bin"
            fi
          done
          
          # Copy boot_app0.bin to chip subfolder
          ESP32_CORE_PATH=$(find ~/.arduino15/packages/esp32/hardware/esp32 -maxdepth 1 -type d -name "${{ env.ESP32_CORE_VERSION }}" | head -1)
          if [ -n "$ESP32_CORE_PATH" ] && [ -f "$ESP32_CORE_PATH/tools/partitions/boot_app0.bin" ]; then
            cp "$ESP32_CORE_PATH/tools/partitions/boot_app0.bin" "../WiFiProvisioning/${{ matrix.chip }}/boot_app0.bin"
          else
            BOOT_APP0=$(find ~/.arduino15/packages/esp32 -name "boot_app0.bin" -type f | head -1)
            cp "$BOOT_APP0" "../WiFiProvisioning/${{ matrix.chip }}/boot_app0.bin"
          fi
          
          echo "Files for ${{ matrix.chip_family }}:"
          ls -la ../WiFiProvisioning/${{ matrix.chip }}/

      - name: Upload firmware artifact for ${{ matrix.chip }}
        uses: actions/upload-artifact@v4
        with:
          name: firmware-WiFiProvisioning-${{ matrix.chip }}
          path: build/WiFiProvisioning/${{ matrix.chip }}/
          retention-days: 30

  # Combine all built firmware | åˆå¹¶æ‰€æœ‰æ„å»ºçš„å›ºä»¶
  combine:
    needs: [detect-changes, build-iot-button, build-wifi-provisioning]
    if: always() && needs.detect-changes.outputs.any_firmware_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-firmware/
          pattern: firmware-*
        continue-on-error: true  # Some artifacts may not exist | æŸäº› artifact å¯èƒ½ä¸å­˜åœ¨

      - name: Check downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la all-firmware/ 2>/dev/null || echo "No artifacts directory"
          find all-firmware -type f 2>/dev/null || echo "No files found"

      - name: Reorganize firmware files
        run: |
          mkdir -p combined-firmware
          
          if [ -d "all-firmware" ]; then
            # Handle IoTButtonV2_DeepSleep (single chip) | å¤„ç† IoTButtonV2_DeepSleepï¼ˆå•èŠ¯ç‰‡ï¼‰
            if [ -d "all-firmware/firmware-IoTButtonV2_DeepSleep" ]; then
              echo "Adding IoTButtonV2_DeepSleep..."
              cp -r "all-firmware/firmware-IoTButtonV2_DeepSleep" "combined-firmware/IoTButtonV2_DeepSleep"
            fi
            
            # Handle WiFiProvisioning (multi-chip) | å¤„ç† WiFiProvisioningï¼ˆå¤šèŠ¯ç‰‡ï¼‰
            mkdir -p combined-firmware/WiFiProvisioning
            
            for chip in C3 C6 S3; do
              if [ -d "all-firmware/firmware-WiFiProvisioning-${chip}" ]; then
                echo "Adding WiFiProvisioning/${chip}..."
                mkdir -p "combined-firmware/WiFiProvisioning/${chip}"
                cp -r "all-firmware/firmware-WiFiProvisioning-${chip}/"* "combined-firmware/WiFiProvisioning/${chip}/"
              fi
            done
          fi
          
          echo ""
          echo "=========================="
          echo "Combined firmware structure:"
          echo "=========================="
          find combined-firmware -type f 2>/dev/null || echo "No firmware files"

      - name: Generate WiFiProvisioning multi-chip manifest
        run: |
          # Create multi-build manifest.json for WiFiProvisioning
          # ESP Web Tools will auto-detect connected chip and use correct build
          if [ -d "combined-firmware/WiFiProvisioning" ] && [ "$(ls -A combined-firmware/WiFiProvisioning 2>/dev/null)" ]; then
            echo "Creating multi-build manifest.json for WiFiProvisioning..."
            
            # Build the manifest using a script approach
            MANIFEST="combined-firmware/WiFiProvisioning/manifest.json"
            
            echo '{' > $MANIFEST
            echo '  "name": "WiFiProvisioning",' >> $MANIFEST
            echo '  "version": "1.0.0",' >> $MANIFEST
            echo '  "home_assistant_domain": "seeed_ha_discovery",' >> $MANIFEST
            echo '  "funding_url": "https://www.seeedstudio.com/",' >> $MANIFEST
            echo '  "new_install_prompt_erase": true,' >> $MANIFEST
            echo '  "new_install_improv_wait_time": 0,' >> $MANIFEST
            echo '  "builds": [' >> $MANIFEST
            
            FIRST=true
            
            # Add C3 build if exists
            if [ -d "combined-firmware/WiFiProvisioning/C3" ]; then
              if [ "$FIRST" = false ]; then echo ',' >> $MANIFEST; fi
              FIRST=false
              echo '    {"chipFamily":"ESP32-C3","parts":[' >> $MANIFEST
              echo '      {"path":"C3/bootloader.bin","offset":0},' >> $MANIFEST
              echo '      {"path":"C3/partitions.bin","offset":32768},' >> $MANIFEST
              echo '      {"path":"C3/boot_app0.bin","offset":57344},' >> $MANIFEST
              echo '      {"path":"C3/firmware.bin","offset":65536}' >> $MANIFEST
              echo '    ]}' >> $MANIFEST
            fi
            
            # Add C6 build if exists
            if [ -d "combined-firmware/WiFiProvisioning/C6" ]; then
              if [ "$FIRST" = false ]; then echo ',' >> $MANIFEST; fi
              FIRST=false
              echo '    {"chipFamily":"ESP32-C6","parts":[' >> $MANIFEST
              echo '      {"path":"C6/bootloader.bin","offset":0},' >> $MANIFEST
              echo '      {"path":"C6/partitions.bin","offset":32768},' >> $MANIFEST
              echo '      {"path":"C6/boot_app0.bin","offset":57344},' >> $MANIFEST
              echo '      {"path":"C6/firmware.bin","offset":65536}' >> $MANIFEST
              echo '    ]}' >> $MANIFEST
            fi
            
            # Add S3 build if exists
            if [ -d "combined-firmware/WiFiProvisioning/S3" ]; then
              if [ "$FIRST" = false ]; then echo ',' >> $MANIFEST; fi
              FIRST=false
              echo '    {"chipFamily":"ESP32-S3","parts":[' >> $MANIFEST
              echo '      {"path":"S3/bootloader.bin","offset":0},' >> $MANIFEST
              echo '      {"path":"S3/partitions.bin","offset":32768},' >> $MANIFEST
              echo '      {"path":"S3/boot_app0.bin","offset":57344},' >> $MANIFEST
              echo '      {"path":"S3/firmware.bin","offset":65536}' >> $MANIFEST
              echo '    ]}' >> $MANIFEST
            fi
            
            echo '  ]' >> $MANIFEST
            echo '}' >> $MANIFEST
            
            echo "Generated manifest.json:"
            cat $MANIFEST
          fi

      - name: Upload combined firmware
        uses: actions/upload-artifact@v4
        with:
          name: all-firmware
          path: combined-firmware/
          retention-days: 90
        if: hashFiles('combined-firmware/**') != ''

  # Create release | åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  release:
    needs: [detect-changes, combine]
    if: always() && needs.detect-changes.outputs.any_firmware_changed == 'true' && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog | å®Œæ•´å†å²ç”¨äºæ›´æ–°æ—¥å¿—

      - name: Download combined firmware
        uses: actions/download-artifact@v4
        with:
          name: all-firmware
          path: firmware/
        continue-on-error: true

      - name: Check firmware exists
        id: check_firmware
        run: |
          if [ -d "firmware" ] && [ "$(ls -A firmware 2>/dev/null)" ]; then
            echo "has_firmware=true" >> $GITHUB_OUTPUT
            echo "Firmware directory contents:"
            find firmware -type f
          else
            echo "has_firmware=false" >> $GITHUB_OUTPUT
            echo "No firmware to release"
          fi

      - name: Get version and changelog
        id: version
        if: steps.check_firmware.outputs.has_firmware == 'true'
        run: |
          VERSION=$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Get the last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          echo "Generating changelog..."
          if [ -n "$LAST_TAG" ]; then
            echo "Changes since $LAST_TAG:"
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | head -30)
          else
            echo "No previous tag found, using last 20 commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          
          echo "$CHANGELOG" > changelog.txt
          cat changelog.txt

      - name: Package firmware
        if: steps.check_firmware.outputs.has_firmware == 'true'
        run: |
          cd firmware
          
          for dir in */; do
            firmware_name="${dir%/}"
            echo "Packaging $firmware_name..."
            zip -r "${firmware_name}.zip" "$dir"
          done
          
          cd ..
          zip -r "all-firmware.zip" firmware/
          mv all-firmware.zip firmware/
          
          echo "Created packages:"
          ls -la firmware/*.zip

      - name: Generate release body
        if: steps.check_firmware.outputs.has_firmware == 'true'
        run: |
          CHANGELOG=$(cat changelog.txt)
          
          # Generate firmware table | ç”Ÿæˆå›ºä»¶è¡¨æ ¼
          # Categorize firmware by type | æŒ‰ç±»å‹åˆ†ç±»å›ºä»¶
          echo "| Firmware | Chip | Description |" > firmware_table.md
          echo "|----------|------|-------------|" >> firmware_table.md
          
          for dir in firmware/*/; do
            firmware_name=$(basename "$dir")
            if [ "$firmware_name" != "*.zip" ]; then
              # Determine chip and description based on firmware name
              # æ ¹æ®å›ºä»¶åç§°ç¡®å®šèŠ¯ç‰‡å’Œæè¿°
              case "$firmware_name" in
                "IoTButtonV2_DeepSleep")
                  echo "| $firmware_name | ESP32-C6 | IoT Button with deep sleep (XIAO ESP32C6 only) |" >> firmware_table.md
                  ;;
                "WiFiProvisioning-C3")
                  echo "| $firmware_name | ESP32-C3 | WiFi provisioning demo (XIAO ESP32C3) |" >> firmware_table.md
                  ;;
                "WiFiProvisioning-C6")
                  echo "| $firmware_name | ESP32-C6 | WiFi provisioning demo (XIAO ESP32C6) |" >> firmware_table.md
                  ;;
                "WiFiProvisioning-S3")
                  echo "| $firmware_name | ESP32-S3 | WiFi provisioning demo (XIAO ESP32S3) |" >> firmware_table.md
                  ;;
                *)
                  echo "| $firmware_name | - | - |" >> firmware_table.md
                  ;;
              esac
            fi
          done
          
          FIRMWARE_TABLE=$(cat firmware_table.md)
          
          cat > release_body.md << ENDOFHEADER
          ## ğŸš€ Firmware Release
          
          Pre-compiled firmware for Seeed HA Discovery devices.
          ä¸º Seeed HA Discovery è®¾å¤‡é¢„ç¼–è¯‘çš„å›ºä»¶ã€‚
          
          ### ğŸ“¥ How to Flash | å¦‚ä½•çƒ§å½•
          
          **Web Flasher (Recommended | æ¨è):**
          Visit [Web Flasher](https://limengdu.github.io/Seeed-Homeassistant-Discovery/flasher/) to flash directly from browser.
          è®¿é—® [ç½‘é¡µçƒ§å½•å™¨](https://limengdu.github.io/Seeed-Homeassistant-Discovery/flasher/) ç›´æ¥ä»æµè§ˆå™¨çƒ§å½•ã€‚
          
          ### ğŸ“¦ Firmware in this release | æœ¬æ¬¡å‘å¸ƒçš„å›ºä»¶
          
          $FIRMWARE_TABLE
          
          > **Note:** WiFiProvisioning is available for multiple ESP32 chips. Choose the variant matching your hardware.
          > **æ³¨æ„ï¼š** WiFiProvisioning æä¾›å¤šç§ ESP32 èŠ¯ç‰‡ç‰ˆæœ¬ï¼Œè¯·é€‰æ‹©ä¸æ‚¨ç¡¬ä»¶åŒ¹é…çš„ç‰ˆæœ¬ã€‚
          
          ### ğŸ“ Changelog | æ›´æ–°æ—¥å¿—
          
          $CHANGELOG
          
          ---
          
          **Build Info | æ„å»ºä¿¡æ¯:**
          - ESP32 Core: ${{ env.ESP32_CORE_VERSION }}
          - ArduinoJson: ${{ env.ARDUINOJSON_VERSION }}
          - WebSockets: ${{ env.WEBSOCKETS_VERSION }}
          - Adafruit NeoPixel: ${{ env.NEOPIXEL_VERSION }}
          - Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Commit: ${{ github.sha }}
          ENDOFHEADER
          
          cat release_body.md

      - name: Create Release
        if: steps.check_firmware.outputs.has_firmware == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware-${{ steps.version.outputs.version }}
          name: Firmware Release ${{ steps.version.outputs.version }}
          body_path: release_body.md
          files: |
            firmware/*.zip
